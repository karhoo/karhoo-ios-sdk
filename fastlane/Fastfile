FASTLANE_HIDE_CHANGELOG = true
FASTLANE_SKIP_UPDATE_CHECK = true
ENV["SLACK_URL"] = "https://hooks.slack.com/workflows/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"

default_platform(:ios)


platform :ios do
  before_all do
    setup_circle_ci
end

 desc "Danger PR Validation"
  lane :DangerPRValidation do
    danger(
      danger_id: "PR_VALIDATION",
      dangerfile: "./DangerfilePRMetaValidation"
     )
 end

 desc "Danger publish test results"
  lane :iosDangerPostCI do
    danger(
      danger_id: "POST_CI",
     )
 end

 desc "Build and prepare the app for testing"
  lane :build_for_test do
   xcodebuild scheme: 'KarhooSDK', destination: "OS=14.0,name=iPhone 11"
end

  desc "Description of what the lane does"
  lane :unit_tests_integration_tests do
	scan(
	    project: "KarhooSDK.xcodeproj",
	    scheme: "KarhooSDK",
	    device: "iPhone 11",
            deployment_target_version: "13.0",
	    code_coverage: true,
	    clean: true,
	    output_types: "junit",
            output_files: "NetworkSDKTests.xml"
    )
  end

  desc "Xcov Report"
  lane :XcovReport do
    xcov(
      workspace: "KarhooSDK.xcodeproj",
      scheme: "KarhooSDK",
      output_directory: "fastlane/test_output",
      ignore_file_path: "./*view.swift",
      slack_channel: "mobile-pull-requests",
      slack_message: "KarhooSDK test coverage report:"
    )
  end

################
# Success/Error:
################

after_all do |lane|
  # This block is called, only if the executed lane was successful
  if ENV["SLACK_URL"]
    slack(
      message: nil,
      success: true,
      default_payloads: [:test_result, :git_branch]
    )
  end

  clean_build_artifacts
end


error do |lane, exception|
  if ENV["SLACK_URL"]
    slack(
      message: exception.to_s,
      success: false
    )
  end

end
